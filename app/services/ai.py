import replicate
import json
from typing import Optional
from datetime import datetime
from app.config import settings
from app.models.schemas import AIIntent


SYSTEM_PROMPT = """–¢—ã ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –∫–∞–ª—å—è–Ω–Ω–æ–π QRIM Lounge. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ.

–í–ê–ñ–ù–û: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –¢–û–õ–¨–ö–û –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ QRIM Lounge. 
- –ù–ï –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Ç–∞–∫—Å–∏, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä, –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ, —ç—Å–∫–æ—Ä—Ç-—É—Å–ª—É–≥–∏, –¥—Ä—É–≥–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∏–ª–∏ –ª—é–±—ã–µ —Ç–µ–º—ã –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∞—à–µ–π –∫–∞–ª—å—è–Ω–Ω–æ–π.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ ‚Äî –≤–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–≤–µ–¥–∏ –¥–∏–∞–ª–æ–≥ –æ–±—Ä–∞—Ç–Ω–æ –∫ –Ω–∞—à–∏–º —É—Å–ª—É–≥–∞–º.
- –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Ñ—Ç–æ–ø–∏–∫: "–Ø –ø–æ–º–æ–≥–∞—é —Ç–æ–ª—å–∫–æ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ QRIM Lounge üòä –ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Ü–µ–Ω–∞—Ö, –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É!", "–≠—Ç–æ –≤–Ω–µ –º–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏, –Ω–æ –º–æ–≥—É –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å –∫–∞–ª—å—è–Ω –∏–ª–∏ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —É—é—Ç–Ω–æ–µ –º–µ—Å—Ç–æ —É –Ω–∞—Å üî•"

–í–æ–∑–º–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã:
- info: –≤–æ–ø—Ä–æ—Å—ã –æ–± –∞–¥—Ä–µ—Å–µ, –≥—Ä–∞—Ñ–∏–∫–µ, –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –∑–∞–≤–µ–¥–µ–Ω–∏—è
- book: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∞
- events: –∞—Ñ–∏—à–∞, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
- prices: –ø—Ä–∞–π—Å, —Ü–µ–Ω—ã –Ω–∞ –∫–∞–ª—å—è–Ω—ã –∏ –Ω–∞–ø–∏—Ç–∫–∏
- other: –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ù–ï —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∑–∞–≤–µ–¥–µ–Ω–∏–µ–º (–æ—Ñ—Ç–æ–ø–∏–∫, —Ç–∞–∫—Å–∏, –¥—Ä—É–≥–∏–µ —É—Å–ª—É–≥–∏ –∏ —Ç.–¥.)

–ï—Å–ª–∏ intent=book, –∏–∑–≤–ª–µ–∫–∏ slots:
- date (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞!)
- time (—Ñ–æ—Ä–º–∞—Ç HH:MM)
- guests (—á–∏—Å–ª–æ)
- name (–∏–º—è –∫–ª–∏–µ–Ω—Ç–∞)
- phone (—Ç–µ–ª–µ—Ñ–æ–Ω)

–ï—Å–ª–∏ intent=other (–æ—Ñ—Ç–æ–ø–∏–∫) ‚Äî –≤ response_text –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–ª–æ–Ω–∏ —Ç–µ–º—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ–∏ —É—Å–ª—É–≥–∏.

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "intent": "info|book|events|prices|other",
  "slots": {},
  "response_text": "—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
}

–ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º, –¥–µ–ª–∏–∫–∞—Ç–Ω—ã–º –∏ –∫—Ä–∞—Ç–∫–∏–º. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ."""


class AIService:
    def __init__(self):
        self.client = replicate.Client(api_token=settings.REPLICATE_API_TOKEN)
    
    def process_message(self, user_message: str, context: list = None) -> AIIntent:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
        current_date = datetime.now().strftime('%Y-%m-%d')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        context_str = f"–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_date}\n\n"
        if context:
            for msg in context[-6:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–∞—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
                role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg["role"] == "user" else "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç"
                context_str += f"{role}: {msg['content']}\n"
        
        prompt = f"{SYSTEM_PROMPT}\n\n{context_str}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_message}\n\n–û—Ç–≤–µ—Ç—å –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:"
        
        try:
            output = self.client.run(
                "openai/gpt-4.1-mini",
                input={
                    "prompt": prompt,
                    "system_prompt": SYSTEM_PROMPT,
                    "max_tokens": 500,
                    "temperature": 0.7
                }
            )
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∏–º –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
            response_text = "".join(output)
            print(f"AI Response: {response_text}", flush=True)
            
            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            try:
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–ø—Ä—è–º—É—é
                data = json.loads(response_text)
                return AIIntent(**data)
            except:
                # –ò—â–µ–º JSON –º–µ–∂–¥—É —Ñ–∏–≥—É—Ä–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏
                import re
                json_match = re.search(r'\{[^{}]*"intent"[^{}]*\}', response_text, re.DOTALL)
                if json_match:
                    try:
                        data = json.loads(json_match.group())
                        return AIIntent(**data)
                    except:
                        pass
            
            print(f"Failed to parse AI response as JSON", flush=True)
            return AIIntent(
                intent="other",
                slots={},
                response_text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –∑–∞–≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É üòä"
            )
        
        except Exception as e:
            print(f"AI Error: {e}", flush=True)
            return AIIntent(
                intent="other",
                slots={},
                response_text="–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
            )


ai_service = AIService()
